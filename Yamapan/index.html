<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヤマパン シール点数計算 v3</title>
    <meta name="description" content="台紙マトリクスと画像一致度(OpenCV.js)を用いたシール自動計算アプリ">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <span class="header-icon">🍞</span>
            <h1>ヤマパン シール計算 <span
                    style="font-size: 0.5em; background: var(--accent-pink-dark); color: white; padding: 2px 6px; border-radius: 4px; vertical-align: middle;">v3</span>
            </h1>
            <p>台紙マトリクス＆画像一致度で自動カウント</p>
        </header>

        <!-- 機能タブ -->
        <div class="tabs">
            <button class="tab-btn active" id="tab-scan">スキャン</button>
            <button class="tab-btn" id="tab-templates">参考画像(辞書)管理</button>
            <button class="tab-btn" id="tab-history">履歴</button>
        </div>

        <div id="view-scan" class="view-section active">
            <!-- 画像入力カード -->
            <section class="card" id="input-card">
                <div class="card-title"><span class="icon">📷</span>シール台紙の画像を読み込む</div>
                <div class="drop-zone" id="drop-zone">
                    <span class="drop-zone-icon">📸</span>
                    <p class="drop-zone-text"><strong>タップして画像を選択</strong><br>またはここにドラッグ＆ドロップ</p>
                    <input type="file" id="file-input" accept="image/*" multiple>
                </div>
            </section>

            <!-- 四隅コンテナ -->
            <section class="card hidden" id="corners-card">
                <div class="card-title">
                    <span class="icon">📐</span>
                    1. 台紙の四隅を指定してください
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">
                    画像の角にある赤い点（1〜4）をドラッグして、シールを貼る台紙の枠（マトリクス）の四隅に合わせてください。
                </p>
                <div class="canvas-container">
                    <canvas id="image-canvas"></canvas>
                </div>
                <button class="btn btn-primary mt-16" id="analyze-button">
                    🔍 このマトリクスを解析する
                </button>
            </section>

            <!-- プログレスバー -->
            <div class="progress-section" id="progress-section">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <p class="progress-text" id="progress-text">準備中...</p>
            </div>

            <!-- 解析結果カード -->
            <section class="card hidden" id="result-card">
                <div class="card-title"><span class="icon">🔎</span>マトリクス解析結果</div>

                <div id="unregistered-warning" class="hidden"
                    style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--accent-gold); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="color: var(--accent-gold); font-size: 0.85rem; margin-bottom: 8px;">
                        ⚠️ 参考画像（辞書）が未登録のため、自動判定できませんでした。
                    </p>
                    <button class="btn btn-secondary w-100" id="go-to-template-btn"
                        style="border-color: var(--accent-gold); color: var(--accent-gold);">
                        参考画像を登録する
                    </button>
                </div>

                <div class="matrix-grid-container">
                    <div class="matrix-grid" id="matrix-grid">
                        <!-- 30マスのプレビューがJSで生成されます -->
                    </div>
                </div>

                <div class="detected-score mt-16" id="detected-score">
                    <!-- 検出された合計点数が表示されます -->
                </div>

                <button class="btn btn-primary" id="confirm-add-button" style="margin-top: 16px;">
                    ✅ この結果を履歴に追加する
                </button>
            </section>
        </div>

        <div id="view-templates" class="view-section hidden">
            <section class="card">
                <div class="card-title"><span class="icon">📚</span>参考画像の登録（辞書）</div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 16px;">
                    各点数のシールを学習させます。スキャンしたマトリクスから、該当する点数の枠をタップして登録してください。<br>
                    ※一度登録すれば次回から自動判定されます。
                </p>

                <div id="template-list" class="template-list">
                    <!-- 0.5, 1, 1.5, ... の登録スロットがJSで生成されます -->
                </div>

                <div class="list-actions">
                    <button class="btn btn-danger" id="clear-templates-btn">辞書をリセットする</button>
                </div>
            </section>
        </div>

        <div id="view-history" class="view-section hidden">
            <!-- シール一覧カード -->
            <section class="card" id="sticker-list-card">
                <div class="card-title">
                    <span class="icon">🎫</span>
                    スキャン履歴
                    <span id="sticker-count"
                        style="margin-left: auto; font-size: 0.75rem; color: var(--text-muted);">0枚</span>
                </div>
                <div class="manual-input-section" style="margin-bottom: 16px;">
                    <div class="manual-input-row">
                        <select class="score-select" id="manual-score-select">
                            <option value="0.5">0.5 点</option>
                            <option value="1" selected>1 点</option>
                            <option value="1.5">1.5 点</option>
                            <option value="2">2 点</option>
                            <option value="2.5">2.5 点</option>
                            <option value="3">3 点</option>
                        </select>
                        <button class="btn btn-secondary" id="manual-add-button">手動追加</button>
                    </div>
                </div>
                <ul class="sticker-list" id="sticker-list">
                    <li class="empty-list" id="empty-list">
                        <span class="empty-list-icon">📭</span>まだ履歴がありません
                    </li>
                </ul>
                <div class="list-actions" id="list-actions" style="display: none;">
                    <button class="btn btn-danger" id="clear-all-button">🗑️ 履歴を全て削除</button>
                </div>
            </section>
        </div>

        <!-- 合計カード（常時表示） -->
        <section class="card total-card" id="total-card">
            <div class="total-content">
                <div>
                    <div class="total-label">履歴の合計点数</div>
                    <div class="total-remaining" id="total-remaining">あと 30 点でお皿と交換！</div>
                </div>
                <div>
                    <span class="total-value" id="total-value">0</span>
                    <span class="total-unit">点</span>
                </div>
            </div>
            <div class="goal-progress-bar">
                <div class="goal-progress-fill" id="goal-progress-fill" style="width: 0%"></div>
            </div>
            <div class="celebration" id="celebration">
                <span class="celebration-emoji">🎉🍽️🎉</span>
                <p class="celebration-text">30点達成！お皿と交換できます！</p>
                <p class="celebration-sub">おめでとうございます🌸</p>
            </div>
        </section>

    </div>

    <!-- テンプレート選択用モーダル -->
    <div id="template-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><span id="modal-target-score"></span> の画像を登録</h3>
                <button class="btn-icon" id="close-modal-btn">✕</button>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">
                以下のスキャンされた枠の中から、該当する点数のシールをタップしてください。
            </p>
            <div class="matrix-grid" id="modal-matrix-grid"></div>
        </div>
    </div>

    <!-- 紙吹雪コンテナ -->
    <div class="confetti-container" id="confetti-container"></div>

    <!-- ローディングオーバーレイ -->
    <div id="opencv-loading"
        style="position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="spinner"></div>
        <p style="margin-top: 16px; font-weight: bold; color: var(--accent-pink);">OpenCV.js を読み込み中...</p>
    </div>

    <!-- OpenCV.js CDN -->
    <script async src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.12.0-release.1/dist/opencv.js"
        onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="script.js"></script>
</body>

</html>