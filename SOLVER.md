# ソルバー解法・難易度判定ロジック

現在の `SudokuLogicalSolver` クラスに実装されている解法と、それに基づく難易度判定の基準について解説します。

## 実装されている解法一覧

ソルバーは人間と同じように論理的な推論を行い、以下の順で解法を適用します。

### 1. Basic (基本)
- **Naked Single (唯一次元)**: あるマスに入る数字の候補が1つしかない場合。
- **Hidden Single (隠れたシングル)**: ある行・列・ブロックにおいて、ある数字が入る場所が1箇所しかない場合。

### 2. Easy (初級)
- **Naked Pair (ネイキッドペア)**: あるユニット（行・列・ブロック）内で、2つのマスが同じ2つの候補を共有している場合、他のマスからその候補を排除できる。
- **Locked Candidates (ポインティング/クレイミング)**: あるブロック内で特定の数字の候補が1行（または1列）に限定される場合、その行（または列）の他のブロック部分からその数字の候補を排除できる（逆も然り）。

### 3. Medium (中級)
- **Hidden Pair (隠れたペア)**: あるユニット内で、2つの数字が特定の2つのマスにしか現れない場合、その2マスから他の数字の候補を排除できる。
- **Naked Triple (ネイキッドトリプル)**: 3つのマスが3つの候補を共有している場合（{1,2}, {1,2}, {1,2} や {1,2}, {2,3}, {1,3} など）。
- **Hidden Triple (隠れたトリプル)**: 3つの数字が特定の3つのマスにしか現れない場合。

### 4. Hard (上級)
- **X-Wing**: 2つの行（または列）で、ある数字の候補が同じ2つの列（または行）に限定されている場合。
- **Y-Wing (XY-Wing)**: 3つのマスが連鎖して候補を絞り込めるパターン（ピボットと2つのウィング）。
- **Swordfish**: X-Wingの3行（列）版。
- **Skyscraper**: X-Wingの変形（2つの強リンク）。
- **W-Wing**: 2つの同一ペアを持つマスが、ある数字の強リンクで結ばれている場合。

## 難易度判定ロジック

パズルを解く過程で使用された**最も高度なテクニック**に基づいて、最終的な難易度を以下の4段階で判定します。

| 難易度 | 必要なテクニック |
| :--- | :--- |
| **basic** | Naked Single (唯一次元) のみで解ける |
| **easy** | **Hidden Single (隠れたシングル)** が必要 |
| **medium** | **Naked Pair / Locked Candidates / Hidden Pair / Triple** が必要 |
| **hard** | **X-Wing / Y-Wing / Swordfish / Skyscraper / W-Wing** が必要 |

# 問題生成ロジック

数独の問題生成は以下の手順で行われます。

1. **完全な盤面の生成**:
   - バックトラッキング法を用いて、ルールに適合するランダムな完全盤面（解答）を生成します。

2. **マスの穴あけ（数字の削除）**:
   - **削除されるマスの数**:
     - **Easy**: 44 ～ 54 個 (ランダム)
     - **Medium / Hard**: 54 ～ 64 個 (ランダム)

3. **解の唯一性チェック**:
   - マスを削除した後、解がただ1つだけ存在することを確認します。解が複数ある場合は削除を取り消し、別のマスを試します。

4. **難易度判定とフィルタリング**:
   - 生成されたパズルを上記の「難易度判定ロジック」で解析します。
   - 指定された難易度と一致すれば採用します。
   - 一致しない場合は再生成を行いますが、タイムアウト時には近似の難易度のパズル（Mediumの場合はEasyを含む）を採用する場合もあります。

## ブラウザでの生成パフォーマンス (平均)

- **Easy (削除44-54)**: ~0.2秒 (超高速)
- **Medium (削除54-64)**: ~0.8秒 (安定)
- **Hard (削除54-64)**: ~0.5秒 (成功時平均)
  - 削除数を55-65に緩和したことで、生成成功率が約70%に向上（以前は40%程度）。
  - フォールバック発生率も約30%に低下し、全体的な生成パフォーマンスが大幅に改善されました。

## ベンチマーク結果（削除マス数 vs 難易度分布）

削除マス数 30～60 の各値について 50 回パズルを生成し、論理ソルバーで難易度を判定した結果です。

| 削除数 | ヒント | basic | easy | medium | hard | unsolved |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 30-46 | 35-51 | ~100% | 0% | 0% | 0-2% | 0% |
| 47 | 34 | 94% | 0% | 0% | 2% | 4% |
| 48 | 33 | 92% | 0% | 0% | 8% | 0% |
| 50 | 31 | 92% | 2% | 0% | 0% | 6% |
| 52 | 29 | 78% | 4% | 0% | 16% | 2% |
| 54 | 27 | 68% | 12% | **4%** | 10% | 6% |
| 56 | 25 | 48% | 6% | **4%** | 16% | 26% |
| 58 | 23 | 32% | 22% | **4%** | 18% | 24% |
| 60 | 21 | 38% | 20% | 2% | 18% | 22% |
| 62 | 19 | 34% | 18% | **6%** | 12% | 30% |
| 64 | 17 | 48% | 16% | **6%** | 2% | 28% |
| 66 | 15 | 50% | 6% | 0% | 10% | 34% |
| 68 | 13 | 34% | 24% | **6%** | 18% | 18% |
| 70 | 11 | 50% | 8% | 2% | 8% | 32% |

> [!IMPORTANT]
> Medium（Hidden Pair / Triple が必要）なパズルは、どの削除数でも**最大 6%**しか出現しません。ランダムな穴あけでは Naked/Hidden Single だけで解けるパズルが圧倒的多数です。
> 削除マス数の最適化だけでは不十分で、生成アルゴリズム自体の改善が必要です。
